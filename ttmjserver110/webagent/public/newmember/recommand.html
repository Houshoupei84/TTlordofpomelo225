<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-cmn-Hans">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1, user-scalable=no">
    <title>我的会员</title>
    <link rel="stylesheet" href="../newcss/reset.css">
    <link href="../bootstrap/css/bootstrap.min.css" title="" rel="stylesheet" />
    <link title="" href="../newcss/style.css" rel="stylesheet" type="text/css"  />
    <link title="blue" href="../newcss/dermadefault.css" rel="stylesheet" type="text/css"/>
    <link href="../newcss/templatecss.css" rel="stylesheet" title="" type="text/css" />
    <link rel="stylesheet" href="../newcss/jqpagination.css">
    <link rel="stylesheet" href="../newcss/bootstrap-modal-bs3patch.css">
    <link rel="stylesheet" href="../newcss/bootstrap-modal.css">
</head>

<body>
<div class="alert alert-info alert-dismissable" role="alert">
    <button class="close" type="button" onclick="$('.alert').eq(0).hide();">&times;</button>
    <span></span>
</div>
<nav class="nav navbar-default navbar-mystyle navbar-fixed-top">
    <div class="navbar-header">
        <button class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand mystyle-brand"><span class="glyphicon glyphicon-user"></span></a></div>
    <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav pull-right">
            <li class="dropdown li-border">
                <a class="mystyle-color" data-toggle="modal" href="#recDes"><span class="glyphicon glyphicon-question-sign"></span>返利说明</a>
            </li>
            <div id="recDes" class="modal fade" tabindex="-1" data-width="760">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h4 class="modal-title">返利说明</h4>
                </div>
                <div class="modal-body">
                    <p class="row"><span class="pull-left col-md-7 col-md-offset-1 col-xs-8 col-xs-offset-1">基础返利:</span><span class="col-md-4 col-xs-3 pull-left" id="rebateBasic"></span></p>
                    <p class="row"><span class="pull-left col-md-7 col-md-offset-1 col-xs-8 col-xs-offset-1">推荐会员<span id="rfRecommand"></span>个充值超过<span id="rfRecharge"></span>元</span><span class="col-md-4 col-xs-3 pull-left">返利:<span id="rebateFirst"></span></span></p>
                    <p class="row"><span class="pull-left col-md-7 col-md-offset-1 col-xs-8 col-xs-offset-1">推荐会员<span id="rsRecommand"></span>个充值超过<span id="rsRecharge"></span>元</span><span class="col-md-4 col-xs-3 pull-left">返利:<span id="rebateSecond"></span></span></p>
                </div>
            </div>
            <li class="li-border" id="renovate">
                <a class="mystyle-color" href="#"><span class="glyphicon glyphicon-repeat"></span>刷新</a>
            </li>
            <li class="dropdown li-border"><a href="#" class="dropdown-toggle mystyle-color" data-toggle="dropdown"><span id="userNick">3179923507@qq.com</span><span class="caret"></span></a>
                <ul class="dropdown-menu">
                    <li><a href="#" id="logout">退出</a></li>
                </ul>
            </li>
        </ul>
    </div>
</nav>
<div class="down-main">
    <div class="left-main left-off">
        <div class="sidebar-fold"><span class="glyphicon glyphicon-menu-hamburger"></span></div>
        <div class="subNavBox">
            <div class="sBox">
                <ul class="navContent" style="display:block">
                    <li>
                        <div class="showtitle" style="width:100px;"><img src="../img/leftimg.png" />首页</div>
                        <a href="index.html"><span class="sublist-icon glyphicon glyphicon-home"></span><span class="sub-title">首页</span></a></li>
                    <li>
                        <div class="showtitle" style="width:100px;"><img src="../img/leftimg.png" />出售</div>
                        <a href="sale.html"><span class="sublist-icon glyphicon glyphicon-tag"></span><span class="sub-title">出售</span></a></li>
                    <li>
                        <div class="showtitle" style="width:100px;"><img src="../img/leftimg.png" />充值</div>
                        <a href="charge.html"><span class="sublist-icon glyphicon glyphicon-shopping-cart"></span><span class="sub-title">充值</span></a></li>
                    <li>
                        <div class="showtitle" style="width:100px;"><img src="../img/leftimg.png" />充值记录</div>
                        <a href="rechargerecord.html"><span class="sublist-icon glyphicon glyphicon-time"></span><span class="sub-title">充值记录</span></a></li>
                    <li>
                        <div class="showtitle" style="width:100px;"><img src="../img/leftimg.png" />出售记录</div>
                        <a href="salerecord.html"><span class="sublist-icon glyphicon glyphicon-star-empty"></span><span class="sub-title">出售记录</span></a></li>
                    <li id="addMember">
                        <div class="showtitle" style="width:100px;"><img src="../img/leftimg.png" />添加会员</div>
                        <a href="addmember.html"><span class="sublist-icon glyphicon glyphicon-plus"></span><span class="sub-title">添加会员</span></a></li>
                    <li  class="active">
                        <div class="showtitle" style="width:100px;"><img src="../img/leftimg.png" />我的会员</div>
                        <a href="recommand.html"><span class="sublist-icon glyphicon glyphicon-user"></span><span class="sub-title">我的会员</span></a></li>
                    <li>
                        <div class="showtitle" style="width:100px;"><img src="../img/leftimg.png" />会员中心</div>
                        <a href="set.html"><span class="sublist-icon glyphicon glyphicon-cog"></span><span class="sub-title">会员中心</span></a></li>
                </ul>
            </div>
        </div>
    </div>
    <div class="right-product right-off">
            <div class="container-fluid">
                <div class="info-center">
                    <div class="page-header">
                        <div class="pull-left">
                            <h4>我的会员<small id="gameName"></small></h4>
                        </div>
                    </div>
                    <div class="search-box row">
                        <div class="col-md-8 col-xs-8">
                            <div class="form-group">
                                <select class="form-control">
                                    <option value="0">会员ID</option>
                                    <option value="1">姓名</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="输入ID" id="userId">
                            </div>
                            <div class="form-group btn-search">
                                <button class="btn btn-default" id="searchById"><span class="glyphicon glyphicon-search"></span></button>
                            </div>
                        </div>
                        <div class="col-md-4 col-xs-4">
                            <div class="pull-right rewardratio">
                                返利比例:<span id="rewardRate"></span>
                            </div>
                        </div>
                    </div>
                    <div class="clearfix"></div>
                    <p class="margin-big-tb text-sub text-default" id="illustration" style="display:none">
                        <span>购买总额:</span><span id="numSum"></span><span>返利总额:</span><span id="chargeSum"></span>
                    </p>
                    <div class="table-margintop" id="dg">
                        <ul>
                            <li>会员ID</li>
                            <li>姓名</li>
                            <li>本周购买</li>
                            <li>返利</li>
                            <li>时间</li>
                        </ul>
                        <div class="pagination pull-right">
                            <a href="#" class="first" data-action="first">&laquo;</a>
                            <a href="#" class="previous" data-action="previous">&lsaquo;</a>
                            <input type="text" readonly="readonly" />
                            <a href="#" class="nextp" data-action="next">&rsaquo;</a>
                            <a href="#" class="lastp" data-action="last">&raquo;</a>
                        </div>
                    </div>
                </div>
            </div>
    </div>
</div>
<script src="../script/jquery-1.11.1.min.js" type="text/javascript"></script>
<script src="../bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
<script src="../script/bootstrap-modalmanager.js"></script>
<script src="../script/bootstrap-modal.js"></script>
<script src="../script/jquery.jqpagination.min.js"></script>
<script src="../script/slidemenu.js"></script>
<script src="../share.js"></script>
<script type="text/javascript">

    $(function(){
        $("#gameName").html(getGameType(window.location.host).agentname);
        var pageLimit = 10;
        menuShow();
        initShowRebate();
        showMembersPage();
        getMyMembers(1);
        function menuShow()
        {
            postJson("/admin/getMyInfo",{msg:"content"},function(rtn) {
                $("#userNick").html(rtn.mName);
                if (rtn) {
                    if (rtn.adminLevel == 2 || rtn.adminLevel == '2') {
                        $("#addMember").css("display", "block");
                    }
                };
            })
        }
        //以下是初始化遮罩层数据的
        function initShowRebate() {
            var rebate = getGameType(window.location.host).rebate;

            $("#rebateBasic").html(rebate.basic.sca / 2 * 100+"%");

            $("#rfRecommand").html(rebate.firstLevel.recommend);
            $("#rfRecharge").html(rebate.firstLevel.recharge);
            $("#rebateFirst").html(rebate.firstLevel.sca / 2 * 100);

            $("#rsRecommand").html(rebate.secondLevel.recommend);
            $("#rsRecharge").html(rebate.secondLevel.recharge);
            $("#rebateSecond").html(rebate.secondLevel.sca / 2 * 100);
        }
        //计算数据总共的页数
        function showMembersPage(pageAll) {
            function getTotalPage(data) {
                return parseInt((data / pageLimit) + (data % pageLimit > 0 ? 1 : 0));
            }
            postJson("/admin/getMyMembersCount",{},
                    function(data)
                    {
                        var pageLimitLast=getTotalPage(data);
                        if(pageLimitLast==0){
                            pageLimitLast+=1;
                        }
                        $('.pagination').jqPagination({
                            max_page	: pageAll?pageAll:pageLimitLast,
                            paged:function(page){
                                getMyMembers(page);
                            }
                        });
                    });
        }
        //以下是点击上一页或者下一页时改变pageNum的函数
        function getMyMembers(pageNum){
            postJson("/admin/getMyMembers",{"limit": pageLimit, "skip":(pageNum-1) * pageLimit},
                    function(data)
                    {
                        postJson("/admin/getRebateJson",{msg:"rebate"},function(dat){
                            var numSum=0;
                            var chargeSum=0;
                            //以下是主体内容部分的添加HTML片段段落,刷新加载页面数据
                            function addItem(data){
                                var time=data.mTime;
                                var timeArr=time.split(/[T\-:\s]/);
                                var tpl='<ul><li>'+data._id+'</li><li>'+data.mNick+'</li><li>'+data.buyTotal+
                                        '</li><li>'+data.buyReward+'</li><li>'+parseInt(timeArr[1],10)+'/'+timeArr[2]+' '+parseInt(timeArr[3],10)+':'+
                                        timeArr[4]+'</li></ul>';
                                return tpl;
                            }

                            var rebate = {};
                            var rebate2 = {};

                            if(dat<= 0){
                                rebate = getGameType(window.location.host).rebate;
                                rebate2 = getGameType(window.location.host).rebate2;
                            }
                            else {
                                rebate = dat.rows[0];
                            }

                            //以下是计算返利比例部分
                            $("#dg>ul:gt(0)").remove();

                            var rewardRate=rebate.basic.sca;//0.16//rebate.basic
                            var rows=data.rows;
                            var bigNum=0;
                            // 以下为按照时间进行逆序排序函数
                            for(var i=0;i<rows.length;i++)
                            {
                                if(rows[i].buyTotal>=rebate.firstLevel.recharge) bigNum++;//1000
                                var time = data.rows[i]["mTime"];
                                time = new Date(time);
                                time = getDateCommonFormat(time);
                                data.rows[i]["mTime"] = time;
                            }

                            if(bigNum>=rebate.firstLevel.recommend)  rewardRate=rebate.firstLevel.sca;//0.2
                            if(bigNum>=rebate.secondLevel.recommend) rewardRate=rebate.secondLevel.sca;//0.24

                            var html=[];
                            if(rows.length==0){
                                $("#illustration").css("display","block");
                                $("#numSum").html(numSum);
                                $("#chargeSum").html(chargeSum);
                                $("#dg>ul").eq(0).after('<ul><li>没有数据!!!</li><li></li><li></li><li></li><li></li><li></li></ul>');
								
                            }else{
                                for(var i=0;i<rows.length;i++)
                                {
                                    var row=rows[i];
                                    row.buyReward=Math.floor(rewardRate*row.buyTotal);
                                    numSum+=row.buyTotal;
                                    chargeSum+=row.buyReward;
                                    html.push(addItem(row));
                                }
                                $("#dg>ul").eq(0).after(html.join(""));
                                $("#illustration").css("display","block");
                                $("#numSum").html(numSum);
                                $("#chargeSum").html(chargeSum);
                            }
                            $("#rewardRate").html(rewardRate/2);
                        });

                    }
            );
        }
        $("#searchById").click(function(e){
            e.preventDefault();
            var key=$("select").val();
            var searchKey={};
            if(key=="0"){
                searchKey={mid:parseInt($("#userId").val())};
            }else{
                searchKey={mNick:$("#userId").val()};
            }
                postJson("/admin/getMymembersBy", searchKey,
                        function(data) {
                            if(data==0){
                                $("#dg>ul:gt(0)").remove();
                                $("#dg>ul").eq(0).after('<ul><li>没有数据!!!</li><li></li><li></li><li></li><li></li><li></li></ul>');
                            }else if(data){
                                $('.pagination').remove();
                                $("#dg>ul:gt(0)").remove();
                                var time=data.mTime;
                                var timeArr=time.split(/[T\-:\s]/);
                                $("#dg>ul").eq(0).after('<ul><li>'+data._id+'</li><li>'+data.mNick+'</li><li>'+data.buyTotal+
                                        '</li><li>'+data.buyReward+'</li><li>'+parseInt(timeArr[1],10)+'/'+timeArr[2]+' '+parseInt(timeArr[3],10)+':'+
                                        timeArr[4]+'</li></ul>');
                            } else {
                                $(".alert").eq(0).alertModal('用户不存在',2000);
                            };


                })
            });
        //点击刷新按钮时重新获取本页数据
        $("#renovate").click(function(){
            location.reload(true);
            getMyMembers(1);
        });
        $("#logout").click(function(e){
            e.preventDefault();
            logout();
        })
    })
</script>
</body>
</html>

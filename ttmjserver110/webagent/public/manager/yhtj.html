<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv=Content-Type content="text/html; charset=UTF-8">
	<link rel="stylesheet" type="text/css" href="/easyui/themes/default/easyui.css">
	<link rel="stylesheet" type="text/css" href="/easyui/themes/icon.css">
	<script type="text/javascript" src="/easyui/jquery.min.js"></script>
	<script type="text/javascript" src="/easyui/jquery.easyui.min.js"></script>
	<script type="text/javascript" src="/share.js"></script>
	<title>用户统计--对战统计移植</title>
</head>
<body  class="easyui-layout">
<div>
	<!--<select id="cc" class="easyui-combobox" name="dept" style="width:200px;">-->
	<!--<option value="ahmj">安徽麻将</option>-->
	<!--<option value="ddz">斗地主</option>-->
	<!--<option value="fjmj">福建麻将</option>-->
	<!--<option value="gdmj">广东麻将</option>-->
	<!--<option value="gsmj">甘肃麻将</option>-->
	<!--<option value="guandan">掼蛋麻将</option>-->
	<!--<option value="gxmj">广西麻将</option>-->
	<!--<option value="gxphz">广西跑胡子</option>-->
	<!--<option value="gzmj">贵州麻将</option>-->
	<!--<option value="hanmj">海南麻将</option>-->
	<!--<option value="henmj">河南麻将</option>-->
	<!--<option value="hnmj">湖南麻将</option>-->
	<!--<option value="jsmj">江苏麻将</option>-->
	<!--<option value="jxmj">江西麻将</option>-->
	<!--<option value="kwx">卡五星</option>-->
	<!--<option value="nxmj">宁夏麻将</option>-->
	<!--<option value="pdk">跑得快</option>-->
	<!--<option value="phz">跑胡子</option>-->
	<!--<option value="scmj">四川麻将</option>-->
	<!--<option value="sdmj">山东麻将</option>-->
	<!--<option value="sxmj">山西麻将</option>-->
	<!--<option value="test">test</option>-->
	<!--<option value="xynmmj">内蒙麻将</option>-->
	<!--<option value="ynmj">云南麻将</option>-->
	<!--<option value="zjmj">浙江麻将</option>-->
	<!--</select>-->
	<input class="easyui-datebox" id="db"/>
	<a href="#" class="easyui-linkbutton" onclick="searchForTJData()">按月查询</a>
	<a href="#" class="easyui-linkbutton" onclick="downLoadXls()">下载excel</a>
</div>
<table  id="tt" class="easyui-datagrid" title="Basic DataGrid" style="width:100%;height:95%"
		data-options="singleSelect:true,collapsible:true">
	<thead>
	<tr>
		<th data-options="field:'_id',width:80">日期</th>
		<th data-options="field:'regCount',width:80">注册总人数</th>
		<th data-options="field:'regInc',width:80">注册增长</th>
		<th data-options="field:'loginCount',width:80">登录人数</th>
		<th data-options="field:'logCountInc',width:80">登录增长</th>
		<th data-options="field:'gameCount',width:80">活跃人数</th>
		<th data-options="field:'gameCountInc',width:80">活跃增长</th>
		<th data-options="field:'gameCount3',width:80">3日活跃</th>
		<th data-options="field:'gameCount7',width:80">7日活跃</th>
		<th data-options="field:'gameCount15',width:80">15日活跃</th>
		<th data-options="field:'gameCount30',width:80">30日活跃</th>
		<th data-options="field:'gameMoney7',width:120">7日活跃库存-钻石</th>
		<th data-options="field:'gameMoney15',width:120">15日活跃库存-钻石</th>
		<th data-options="field:'gameMoney30',width:120">30日活跃库存-钻石</th>
		<th data-options="field:'buyUserCount',width:80">充值人数</th>
		<th data-options="field:'buyCount',width:80">充值次数</th>
		<th data-options="field:'buyDiamonds',width:80">充值数量-钻</th>
		<th data-options="field:'arpu',width:180">ARPU(充值数量/活跃人数)</th>
		<th data-options="field:'arppu',width:180">ARPPU(充值数量/充值人数)</th>
		<th data-options="field:'balance',width:80">剩余钻石</th>
	</tr>
	</thead>
</table>
<script type="text/javascript">
	<!--初始化日历控件-->
	var xls=[{
		_id:"日期",
		regCount:"注册总人数",
		regInc:"注册增长",
		loginCount:"登录人数",
		logCountInc:"登录增长",
		gameCount:"活跃人数",
		gameCountInc:"活跃增长",
		gameCount3:"3日活跃",
		gameCount7:"7日活跃",
		gameCount15:"15日活跃",
		gameCount30:"30日活跃",
		gameMoney7:"7日活跃库存-钻石",
		gameMoney15:"15日活跃库存-钻石",
		gameMoney30:"30日活跃库存-钻石",
		buyUserCount:"充值人数",
		buyCount:"充值次数",
		buyDiamonds:"充值数量-钻",
		arpu:"ARPU(充值数量/活跃人数)",
		arppu:"ARPPU(充值数量/充值人数)",
		balance:"用户余额"
	}];
	var xls1=[];
	$(function () {
		var db = $('#db');
		db.datebox({
			onShowPanel: function () {//显示日趋选择对象后再触发弹出月份层的事件，初始化时没有生成月份层
				span.trigger('click'); //触发click事件弹出月份层
				if (!tds) setTimeout(function () {//延时触发获取月份对象，因为上面的事件触发和对象生成有时间间隔
					tds = p.find('div.calendar-menu-month-inner td');
					tds.click(function (e) {
						e.stopPropagation(); //禁止冒泡执行easyui给月份绑定的事件
						var year = /\d{4}/.exec(span.html())[0]//得到年份
								, month = parseInt($(this).attr('abbr'), 10); //月份，这里不需要+1
						db.datebox('hidePanel')//隐藏日期对象
								.datebox('setValue', year + "-" + month); //设置日期的值
					});
				}, 0);
				yearIpt.unbind();//解绑年份输入框中任何事件
			},
			parser: function (s) {
				if (!s) return new Date();
				var arr = s.split('-');
				return new Date(parseInt(arr[0], 10), parseInt(arr[1], 10) - 1, 1);
			},
			formatter: function (d) {
				return d.getFullYear()+ '-'+(d.getMonth()+1);
			}
		});
		var p = db.datebox('panel'), //日期选择对象
				tds = false, //日期选择对象中月份
				aToday = p.find('a.datebox-current'),
				yearIpt = p.find('input.calendar-menu-year'),//年份输入框
		//显示月份层的触发控件
				span = aToday.length ? p.find('div.calendar-title span') ://1.3.x版本
						p.find('span.calendar-text'); //1.4.x版本
		if (aToday.length) {//1.3.x版本，取消Today按钮的click事件，重新绑定新事件设置日期框为今天，防止弹出日期选择面板

			aToday.unbind('click').click(function () {
				var now = new Date();
				db.datebox('hidePanel').datebox('setValue', now.getFullYear() + (now.getMonth() + 1));
			});
		}
	});
	function searchForTJData() {
		var startDate=$("#db").datebox('getValue');
		if(!startDate){
			$.messager.alert("操作提示","请选择月份","error");
			return;
		}
		var dateArr=startDate.split('-');
		var monthNum = new Date(dateArr[0], dateArr[1], '00').getDate();//每月天数
		if(dateArr[1]<10){
			dateArr[1]='0'+dateArr[1];
		}
		startDate=dateArr[0]+dateArr[1]+'01';
		var endDate = dateArr[0]+dateArr[1]+monthNum;
		postJson("/userData/getUserStatisticsActive", {start:startDate, end:endDate}, function (data) {
			if(data && data.rows) {
				var newData = [];
				var relData = data.rows;
				// 合计栏
				var total =
				{
					_id: '合计',
					regCount: 0,
					regInc: 0,
					loginCount: 0,
					logCountInc: 0,
					gameCount: 0,
					gameCountInc: 0,
					gameCount3: "-",
					gameCount7: "-",
					gameCount15: "-",
					gameCount30: "-",
					gameMoney7:"-",
					gameMoney15:"-",
					gameMoney30:"-",
					buyUserCount: 0,
					buyCount: 0,
					buyDiamonds: 0,
					arpu: 0,
					arppu:0,
					balance: 0
				};

				for (var count = 1; count < relData.length; count++) {
					var currentMemberInfo = relData[count];
					var day = currentMemberInfo._id;
					var regTotal = currentMemberInfo.regTotal;
					var regInc = currentMemberInfo.regCount;
					var loginCount = currentMemberInfo.loginCount;
					var activeCount = currentMemberInfo.activeCount;


					var dataYesterday = relData[count - 1];
					var logCountInc = currentMemberInfo.loginCount - dataYesterday.loginCount;
					var gameCountInc = currentMemberInfo.activeCount - dataYesterday.activeCount;

					var day03 = currentMemberInfo.gameCount3;
					var day07 = currentMemberInfo.gameCount7;
					var day15 = currentMemberInfo.gameCount15;
					var day30 = currentMemberInfo.gameCount30;
					var gameMoney7=currentMemberInfo.gameMoney7;
					var gameMoney15=currentMemberInfo.gameMoney15;
					var gameMoney30=currentMemberInfo.gameMoney30;

					var buyUserCount = currentMemberInfo.buyNum||0;
					var buyCount = currentMemberInfo.buyCount||0;
					var buyDiamonds = currentMemberInfo.buyDiamonds||0;
					var userDiamonds = currentMemberInfo.userDiamonds||0;

					var arpu = regTotal>0?(parseFloat(buyDiamonds)/activeCount).toFixed(2):0;//充值数量/活跃人数
					var arppu = buyUserCount>0?(parseFloat(buyDiamonds)/buyUserCount).toFixed(2):0;//充值数量/充值人数
					var obj =
					{
						_id: day,
						regCount: regTotal,
						regInc: regInc,
						loginCount: loginCount,
						logCountInc: logCountInc,
						gameCount: activeCount,
						gameCountInc: gameCountInc,
						gameCount3: day03,
						gameCount7: day07,
						gameCount15: day15,
						gameCount30: day30,
						gameMoney7:gameMoney7,
						gameMoney15:gameMoney15,
						gameMoney30:gameMoney30,
						buyUserCount: buyUserCount,
						buyCount: buyCount,
						buyDiamonds: buyDiamonds,
						arpu: arpu,
						arppu:arppu,
						balance: userDiamonds
					};
					newData.push(obj);
					total.regCount = regTotal;
					total.regInc = regInc;
					total.loginCount = currentMemberInfo.loginTotal;
					total.logCountInc = currentMemberInfo.loginTotal;
					total.gameCount = currentMemberInfo.activeTotal;
					total.gameCountInc = currentMemberInfo.activeTotal;
					total.buyUserCount += buyUserCount;
					total.buyCount += buyCount;
					total.buyDiamonds += buyDiamonds;
					total.arpu += parseFloat(arpu);
					total.arppu += parseFloat(arppu);
					total.balance += userDiamonds;
				}
				if(relData.length > 0)
				{
					total.arpu = (total.arpu/(relData.length - 1)).toFixed(2);
					total.arppu = (total.arppu/(relData.length - 1)).toFixed(2);
				}
				newData.push(total);
				xls1=[];
				xls1 = xls.concat(newData);
				$("#tt").datagrid("loadData", newData);
			}
			else
			{
				$.messager.alert("操作提示", "数据请求失败", "error");
			}
		});
	}
	function compute(tableName,colName){
		var rows = $('#'+tableName).datagrid('getRows');
		var total = 0;
		for (var i = 1; i < rows.length; i++) {
			if(!rows[i][colName]){
				rows[i][colName]=0;
			}
			total += parseFloat(rows[i][colName]);
		}
		return total;
	}
	//数据格式
	function downLoadXls(){
		if(!xls1)
		{
			$.messager.alert("操作提示", "无数据可导出1","error");
			return;
		}
		postJson("/tools/downloadExcelFile",{data:xls1},
				function(data)
				{
					console.log(data);
					if(data)
					{
						console.log(parent.document.location.origin);
						document.location.href = parent.document.location.origin  + data;
					}else
					{
						$.messager.alert("操作提示", "无数据可导出2","error");
					}
				});

	}

	function collection(tempDate, nDayAfter, info) {
		var currentDate = dateOffset(tempDate, nDayAfter);
		var ret = 0;
		currentDate += "_active";	//活跃时间
		if (currentDate in info) {
			ret = info[currentDate];
		}
		//console.log("tempDate,nDayAfter,currentDate, info[currentDate]",tempDate,nDayAfter,currentDate, info[currentDate]);
		return ret;
	}
	var dateOffset = function (date, day)
	{
		day = day || 0;
		var cDate = (typeof  date == 'string') ? new Date(date) : date;
		cDate.setDate(cDate.getDate() + day);
		return Number(cDate.Format('yyyyMMdd'));
	};
	var cut = function (str, rules, separator)
	{
		var startPos = 0;
		var endPos = 0;
		var newStr = '';
		str = String(str);
		for (var count = 0; count < rules.length; count++)
		{
			endPos = startPos + rules[count];
			newStr += str.substring(startPos, endPos);
			if (count != rules.length - 1)
			{
				newStr += separator;
			}
			startPos = endPos;
		}
		return newStr;
	};
</script>
</body>
</html>
/*
 * 移动端图片手势缩放
 * create:
 * zhaolongwei
 * 20161206
 */
(function(){var a=function(d){var f=function(h,g){this.el=d(h);this.zoomFactor=1;this.lastScale=1;this.offset={x:0,y:0};this.options=d.extend({},this.defaults,g);this.setupMarkup();this.bindEvents();this.update();this.enable()},c=function(h,g){return h+g},e=function(h,g){return h>g-0.01&&h<g+0.01};f.prototype={defaults:{tapZoomFactor:2,zoomOutFactor:1.3,animationDuration:300,maxZoom:4,minZoom:0.5,lockDragAxis:false,use2d:true,zoomStartEventName:"pz_zoomstart",zoomEndEventName:"pz_zoomend",dragStartEventName:"pz_dragstart",dragEndEventName:"pz_dragend",doubleTapEventName:"pz_doubletap"},handleDragStart:function(g){this.el.trigger(this.options.dragStartEventName);this.stopAnimation();this.lastDragPosition=false;this.hasInteraction=true;this.handleDrag(g)},handleDrag:function(g){if(this.zoomFactor>1){var h=this.getTouches(g)[0];this.drag(h,this.lastDragPosition);this.offset=this.sanitizeOffset(this.offset);this.lastDragPosition=h}},handleDragEnd:function(){this.el.trigger(this.options.dragEndEventName);this.end()},handleZoomStart:function(g){this.el.trigger(this.options.zoomStartEventName);this.stopAnimation();this.lastScale=1;this.nthZoom=0;this.lastZoomCenter=false;this.hasInteraction=true},handleZoom:function(h,j){var g=this.getTouchCenter(this.getTouches(h)),i=j/this.lastScale;this.lastScale=j;this.nthZoom+=1;if(this.nthZoom>3){this.scale(i,g);this.drag(g,this.lastZoomCenter)}this.lastZoomCenter=g},handleZoomEnd:function(){this.el.trigger(this.options.zoomEndEventName);this.end()},handleDoubleTap:function(h){var i=this.getTouches(h)[0],g=this.zoomFactor>1?1:this.options.tapZoomFactor,k=this.zoomFactor,j=(function(l){this.scaleTo(k+l*(g-k),i)}).bind(this);if(this.hasInteraction){return}if(k>g){i=this.getCurrentZoomCenter()}this.animate(this.options.animationDuration,j,this.swing);this.el.trigger(this.options.doubleTapEventName)},sanitizeOffset:function(m){var l=(this.zoomFactor-1)*this.getContainerX(),k=(this.zoomFactor-1)*this.getContainerY(),g=Math.max(l,0),h=Math.max(k,0),j=Math.min(l,0),i=Math.min(k,0);return{x:Math.min(Math.max(m.x,j),g),y:Math.min(Math.max(m.y,i),h)}},scaleTo:function(g,h){this.scale(g/this.zoomFactor,h)},scale:function(h,g){h=this.scaleZoomFactor(h);this.addOffset({x:(h-1)*(g.x+this.offset.x),y:(h-1)*(g.y+this.offset.y)})},scaleZoomFactor:function(h){var g=this.zoomFactor;this.zoomFactor*=h;this.zoomFactor=Math.min(this.options.maxZoom,Math.max(this.zoomFactor,this.options.minZoom));return this.zoomFactor/g},drag:function(h,g){if(g){if(this.options.lockDragAxis){if(Math.abs(h.x-g.x)>Math.abs(h.y-g.y)){this.addOffset({x:-(h.x-g.x),y:0})}else{this.addOffset({y:-(h.y-g.y),x:0})}}else{this.addOffset({y:-(h.y-g.y),x:-(h.x-g.x)})}}},getTouchCenter:function(g){return this.getVectorAvg(g)},getVectorAvg:function(g){return{x:g.map(function(h){return h.x}).reduce(c)/g.length,y:g.map(function(h){return h.y}).reduce(c)/g.length}},addOffset:function(g){this.offset={x:this.offset.x+g.x,y:this.offset.y+g.y}},sanitize:function(){if(this.zoomFactor<this.options.zoomOutFactor){this.zoomOutAnimation()}else{if(this.isInsaneOffset(this.offset)){this.sanitizeOffsetAnimation()}}},isInsaneOffset:function(h){var g=this.sanitizeOffset(h);return g.x!==h.x||g.y!==h.y},sanitizeOffsetAnimation:function(){var i=this.sanitizeOffset(this.offset),g={x:this.offset.x,y:this.offset.y},h=(function(j){this.offset.x=g.x+j*(i.x-g.x);this.offset.y=g.y+j*(i.y-g.y);this.update()}).bind(this);this.animate(this.options.animationDuration,h,this.swing)},zoomOutAnimation:function(){var j=this.zoomFactor,g=1,h=this.getCurrentZoomCenter(),i=(function(k){this.scaleTo(j+k*(g-j),h)}).bind(this);this.animate(this.options.animationDuration,i,this.swing)},updateAspectRatio:function(){this.setContainerY(this.getContainerX()/this.getAspectRatio())},getInitialZoomFactor:function(){return this.container[0].offsetWidth/this.el[0].offsetWidth},getAspectRatio:function(){return this.el[0].offsetWidth/this.el[0].offsetHeight},getCurrentZoomCenter:function(){var n=this.container[0].offsetWidth*this.zoomFactor,m=this.offset.x,k=n-m-this.container[0].offsetWidth,g=m/k,l=g*this.container[0].offsetWidth/(g+1),p=this.container[0].offsetHeight*this.zoomFactor,o=this.offset.y,i=p-o-this.container[0].offsetHeight,h=o/i,j=h*this.container[0].offsetHeight/(h+1);if(k===0){l=this.container[0].offsetWidth}if(i===0){j=this.container[0].offsetHeight}return{x:l,y:j}},canDrag:function(){return !e(this.zoomFactor,1)},getTouches:function(h){var g=this.container.offset();return Array.prototype.slice.call(h.touches).map(function(i){return{x:i.pageX-g.left,y:i.pageY-g.top}})},animate:function(l,k,j,i){var g=new Date().getTime(),h=(function(){if(!this.inAnimation){return}var n=new Date().getTime()-g,m=n/l;if(n>=l){k(1);if(i){i()}this.update();this.stopAnimation();this.update()}else{if(j){m=j(m)}k(m);this.update();requestAnimationFrame(h)}}).bind(this);this.inAnimation=true;requestAnimationFrame(h)},stopAnimation:function(){this.inAnimation=false},swing:function(g){return -Math.cos(g*Math.PI)/2+0.5},getContainerX:function(){return this.container[0].offsetWidth},getContainerY:function(){return this.container[0].offsetHeight},setContainerY:function(g){return this.container.height(g)},setupMarkup:function(){this.container=d('<div class="pinch-zoom-container"></div>');this.el.before(this.container);this.container.append(this.el);this.container.css({overflow:"hidden",position:"relative"});this.el.css({"-webkit-transform-origin":"0% 0%","-moz-transform-origin":"0% 0%","-ms-transform-origin":"0% 0%","-o-transform-origin":"0% 0%","transform-origin":"0% 0%",position:"absolute"})},end:function(){this.hasInteraction=false;this.sanitize();this.update()},bindEvents:function(){b(this.container.get(0),this);d(window).on("resize",this.update.bind(this));d(this.el).find("img").on("load",this.update.bind(this))},update:function(){if(this.updatePlaned){return}this.updatePlaned=true;setTimeout((function(){this.updatePlaned=false;this.updateAspectRatio();var g=this.getInitialZoomFactor()*this.zoomFactor,k=-this.offset.x/g,l=-this.offset.y/g,h="scale3d("+g+", "+g+",1) translate3d("+k+"px,"+l+"px,0px)",j="scale("+g+", "+g+") translate("+k+"px,"+l+"px)",i=(function(){if(this.clone){this.clone.remove();delete this.clone}}).bind(this);if(!this.options.use2d||this.hasInteraction||this.inAnimation){this.is3d=true;i();this.el.css({"-webkit-transform":h,"-o-transform":j,"-ms-transform":j,"-moz-transform":j,transform:h})}else{if(this.is3d){this.clone=this.el.clone();this.clone.css("pointer-events","none");this.clone.appendTo(this.container);setTimeout(i,200)}this.el.css({"-webkit-transform":j,"-o-transform":j,"-ms-transform":j,"-moz-transform":j,transform:j});this.is3d=false}}).bind(this),0)},enable:function(){this.enabled=true},disable:function(){this.enabled=false}};var b=function(k,i){var s=null,n=0,o=null,t=null,l=function(u,v){if(s!==u){if(s&&!u){switch(s){case"zoom":i.handleZoomEnd(v);break;case"drag":i.handleDragEnd(v);break}}switch(u){case"zoom":i.handleZoomStart(v);break;case"drag":i.handleDragStart(v);break}}s=u},p=function(u){if(n===2){l("zoom")}else{if(n===1&&i.canDrag()){l("drag",u)}else{l(null,u)}}},q=function(u){return Array.prototype.slice.call(u).map(function(v){return{x:v.pageX,y:v.pageY}})},j=function(w,v){var u,z;u=w.x-v.x;z=w.y-v.y;return Math.sqrt(u*u+z*z)},m=function(w,x){var v=j(w[0],w[1]),u=j(x[0],x[1]);return u/v},h=function(u){u.stopPropagation();u.preventDefault()},r=function(u){var v=(new Date()).getTime();if(n>1){o=null}if(v-o<300){h(u);i.handleDoubleTap(u);switch(s){case"zoom":i.handleZoomEnd(u);break;case"drag":i.handleDragEnd(u);break}}if(n===1){o=v}},g=true;k.addEventListener("touchstart",function(u){if(i.enabled){g=true;n=u.touches.length;r(u)}});k.addEventListener("touchmove",function(u){if(i.enabled){if(g){p(u);if(s){h(u)}t=q(u.touches)}else{switch(s){case"zoom":i.handleZoom(u,m(t,q(u.touches)));break;case"drag":i.handleDrag(u);break}if(s){h(u);i.update()}}g=false}});k.addEventListener("touchend",function(u){if(i.enabled){n=u.touches.length;p(u)}})};return f};if(typeof define!=="undefined"&&define.amd){define(["jquery"],function(b){return a(b)})}else{window.RTP=window.RTP||{};window.RTP.PinchZoom=a(window.$)}}).call(this);
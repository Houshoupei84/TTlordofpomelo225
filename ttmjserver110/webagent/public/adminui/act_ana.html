<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv=Content-Type content="text/html; charset=UTF-8">
    <link rel="stylesheet" type="text/css" href="/easyui/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="/easyui/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="/ui/materialRippleEffect/icon.css">
    <link rel="stylesheet" type="text/css" href="/ui/zeroModal/css/zeroModal.css">
    <title>用户活跃查询</title>
    <script type="text/javascript" src="/easyui/jquery.min.js"></script>
    <script type="text/javascript" src="/easyui/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="/share.js"></script>
    <script type="text/javascript" src="/ui/materialRippleEffect/ripple.js"></script>
    <script type="text/javascript" src="/ui/zeroModal/js/zeroModal.js"></script>
    <script type="text/javascript" src="/easyui/locale/easyui-lang-zh_CN.js"></script>
</head>
<body>
<div>
    <input class="easyui-datebox" id="db"/>
    <a href="#" class="easyui-linkbutton" onclick="monthActRecord()">按月查询</a>
    <input class="easyui-datebox" id="date_start"/>
    <input class="easyui-datebox" id="date_end"/>
    <a href="#" class="easyui-linkbutton" onclick="daysActRecord()">按日期查询</a>
    <a href="#" class="easyui-linkbutton" onclick="downLoadXls()">下载excel</a>
</div>
<table  id="tt" class="easyui-datagrid" title="Basic DataGrid" style="width:100%;height:600px"
        data-options="singleSelect:true,collapsible:true">
    <thead>
    <tr>
        <th data-options="field:'_id',width:80">日期</th>
        <th data-options="field:'regCount',width:80">活跃人数</th>
        <th data-options="field:'zero',width:80">1时</th>
        <th data-options="field:'one',width:80">2时</th>
        <th data-options="field:'two',width:80">3时</th>
        <th data-options="field:'three',width:80">4时</th>
        <th data-options="field:'four',width:80">5时</th>
        <th data-options="field:'five',width:80">6时</th>
        <th data-options="field:'six',width:80">7时</th>
        <th data-options="field:'seven',width:80">8时</th>
        <th data-options="field:'eight',width:80">9时</th>
        <th data-options="field:'nine',width:80">10时</th>
        <th data-options="field:'ten',width:80">11时</th>
        <th data-options="field:'eleven',width:80">12时</th>
        <th data-options="field:'twelve',width:80">13时</th>
        <th data-options="field:'thirteen',width:80">14时</th>
        <th data-options="field:'fourteen',width:80">15时</th>
        <th data-options="field:'fifteen',width:80">16时</th>
        <th data-options="field:'sixteen',width:80">17时</th>
        <th data-options="field:'seventeen',width:80">18时</th>
        <th data-options="field:'eighteen',width:80">19时</th>
        <th data-options="field:'ninteen',width:80">20时</th>
        <th data-options="field:'twenty',width:80">21时</th>
        <th data-options="field:'twentyone',width:80">22时</th>
        <th data-options="field:'twentytwo',width:80">23时</th>
        <th data-options="field:'twentythree',width:80">24时</th>
    </tr>
    </thead>
</table>
<script>
    function compute(tableName,colName) {
        var rows = $('#'+tableName).datagrid('getRows');
        var total = 0;
        for (var i = 0; i < rows.length; i++) {
            if(!rows[i][colName]||rows[i][colName]=='-'){
                rows[i][colName]=0;
            }
            total += parseFloat(rows[i][colName]);
        }
        return total;
    }
    function aver(tableName,colName) {
        var rows = $('#'+tableName).datagrid('getRows');
        var total = 0;
        var j=0;
        for (var i = 0; i < rows.length-1; i++) {
            if(!rows[i][colName]||rows[i][colName]=='-'){
                rows[i][colName]=0;
                j++
            }
            total += parseFloat(rows[i][colName]);
        }
        return (total/(rows.length-1-j)).toFixed(2);
    }
/*	var noneNumber = 0;*/
    function monthActRecord(){
        var date=$("#db").datebox('getValue');
        if(!date){
            $.messager.alert("操作提示","请选择月份","error");
            return;
        }
        var dateArr=date.split('-');
        var year=new Date().getFullYear();
        var month=new Date().getMonth()+1;
        if(dateArr[1]<10){
            dateArr[1]='0'+dateArr[1];
        }
        var days=new Date(dateArr[0],dateArr[1],"00").getDate();
        if(days<10){
            days='0'+days;
        }
        var startday=dateArr[0]+dateArr[1]+"01";
        var endday=dateArr[0]+dateArr[1]+days;
        if(dateArr[0]>year){
            $.messager.alert("操作提示","选择年份超过当前年份","error");
            return;
        }
        if(dateArr[0]==year){
            if(dateArr[1]>month){
                $.messager.alert("操作提示","选择月份超过当月","error");
                return;
            }
        }
        getUserActRecord(startday,endday);
    }
    function daysActRecord(){
        var sta_Date=$("#date_start").datebox('getValue');
        var end_Date=$("#date_end").datebox('getValue');
        if(!sta_Date||!end_Date){
            $.messager.alert("操作提示","请选择日期","error");
            return;
        }
        var staArr=sta_Date.split('-');
        var endArr=end_Date.split('-');
        var startday=staArr[0]+staArr[1]+staArr[2];
        var endday=endArr[0]+endArr[1]+endArr[2];
        var starttime=new Date(staArr[0],staArr[1]-1,staArr[2]).getTime();
        var endtime=new Date(endArr[0],endArr[1]-1,endArr[2]).getTime();
        var endtimeyet=new Date().getTime();
        if(starttime>endtime){
            $.messager.alert("操作提示","起始日期大于结束日期","error");
            return;
        }else if(endtime>endtimeyet){
            $.messager.alert("操作提示","结束日期超过今天","error");
            return;
        }
        getUserActRecord(startday,endday);
    }
    function getUserActRecord(startday,endday)
    {
//        console.log("=======> startday: ",startday,endday);
        postJson("/userData/getUserStatistics", {start:startday,end:endday},
                function (data)
                {
                    if (data && data.rows && data.rows.length)
                    {
                        refreshUI(data);
                    }
                    else
                    {
                        $.messager.alert("操作提示","没有数据","error");
                    }
                }
        );
    }
    function refreshUI(data){
        var newdata={};
        var newrows=[];
        var arr=["zero","one","two","three","four","five","six","seven","eight","nine","ten","eleven","twelve","thirteen","fourteen","fifteen","sixteen","seventeen","eighteen","ninteen","twenty","twentyone","twentytwo","twentythree"];
        var relData = data.rows;
//        console.log("=======> data: " + JSON.stringify(data));
        //var i=1; db默认往前多找一天
        for(var i=1;i<relData.length;i++){
            var temp={};
            temp["_id"]=relData[i]["_id"];
            temp["regCount"]=relData[i]["loginCount"];
            temp["activeCount"]=relData[i]["activeCount"];
            if(relData[i]["activeTimes"]){
                for(var j=0;j<relData[i]["activeTimes"].length;j++){
                    temp[arr[j]]=relData[i]["activeTimes"][j];
                }
            }else{
                for(var l=0;l<arr.length;l++){
                    temp[arr[l]]="-";
                }
//                noneNumber++;
            }
            newrows.push(temp);
        }
        var newtotal=relData.length;
        newdata.total=newtotal;
        newdata.rows=newrows;
        xls1=[];
        xls1 = xls.concat(newrows);
/*        var row={
            _id: '合计',
            regCount:compute("tt","regCount"),
            zero: compute("tt","zero"),
            one:compute("tt","one"),
            two:compute("tt","two"),
            three:compute("tt","three"),
            four:compute("tt","four"),
            five:compute("tt","five"),
            six:compute("tt","six"),
            seven:compute("tt","seven"),
            eight:compute("tt","eight"),
            nine:compute("tt","nine"),
            ten:compute("tt","ten"),
            eleven:compute("tt","eleven"),
            twelve:compute("tt","twelve"),
            thirteen:compute("tt","thirteen"),
            fourteen:compute("tt","fourteen"),
            fifteen:compute("tt","fifteen"),
            sixteen:compute("tt","sixteen"),
            seventeen:compute("tt","seventeen"),
            eighteen:compute("tt","eighteen"),
            ninteen:compute("tt","ninteen"),
            twenty:compute("tt","twenty"),
            twentyone:compute("tt","twentyone"),
            twentytwo:compute("tt","twentytwo"),
            twentythree:compute("tt","twentythree")
        };
        var averageNum =  {
				_id:"平均",
				regCount:average("tt","regCount"),
				zero:average("tt","zero"),
				one:average("tt","one"),
				two:average("tt","two"),
				three:average("tt","three"),
				four:average("tt","four"),
				five:average("tt","five"),
				six:average("tt","six"),
				seven:average("tt","seven"),
				eight:average("tt","eight"),
				nine:average("tt","nine"),
				ten:average("tt","ten"),
				eleven:average("tt","eleven"),
				twelve:average("tt","twelve"),
				thirteen:average("tt","thirteen"),
				fourteen:average("tt","fourteen"),
				fifteen:average("tt","fifteen"),
				sixteen:average("tt","sixteen"),
				seventeen:average("tt","seventeen"),
				eighteen:average("tt","eighteen"),
				ninteen:average("tt","ninteen"),
				twenty:average("tt","twenty"),
				twentyone:average("tt","twentyone"),
				twentytwo:average("tt","twentytwo"),
				twentythree:average("tt","twentythree")
			};*/
        $("#tt").datagrid("loadData",newdata);
        var row = {};
        row["_id"]='合计';
        row["regCount"]= compute("tt","regCount");
        row["zero"]=compute("tt","zero");
        row["one"]=compute("tt","one");
        row["two"]=compute("tt","two");
        row["three"]=compute("tt","three");
        row["four"]=compute("tt","four");
        row["five"]=compute("tt","five");
        row["six"]=compute("tt","six");
        row["seven"]=compute("tt","seven");
        row["eight"]=compute("tt","eight");
        row["nine"]=compute("tt","nine");
        row["ten"]=compute("tt","ten");
        row["eleven"]=compute("tt","eleven");
        row["twelve"]=compute("tt","twelve");
        row["thirteen"]=compute("tt","thirteen");
        row["fourteen"]=compute("tt","fourteen");
        row["fifteen"]=compute("tt","fifteen");
        row["sixteen"]=compute("tt","sixteen");
        row["seventeen"]=compute("tt","seventeen");
        row["eighteen"]=compute("tt","eighteen");
        row["ninteen"]=compute("tt","ninteen");
        row["twenty"]=compute("tt","twenty");
        row["twentyone"]=compute("tt","twentyone");
        row["twentytwo"]=compute("tt","twentytwo");
        row["twentythree"]=compute("tt","twentythree");
        $("#tt").datagrid('appendRow',row);
        xls1.push(row);
        var row1 = {};
        row1["_id"]='平均';
        row1["regCount"]= aver("tt","regCount");
        row1["zero"]=aver("tt","zero");
        row1["one"]=aver("tt","one");
        row1["two"]=aver("tt","two");
        row1["three"]=aver("tt","three");
        row1["four"]=aver("tt","four");
        row1["five"]=aver("tt","five");
        row1["six"]=aver("tt","six");
        row1["seven"]=aver("tt","seven");
        row1["eight"]=aver("tt","eight");
        row1["nine"]=aver("tt","nine");
        row1["ten"]=aver("tt","ten");
        row1["eleven"]=aver("tt","eleven");
        row1["twelve"]=aver("tt","twelve");
        row1["thirteen"]=aver("tt","thirteen");
        row1["fourteen"]=aver("tt","fourteen");
        row1["fifteen"]=aver("tt","fifteen");
        row1["sixteen"]=aver("tt","sixteen");
        row1["seventeen"]=aver("tt","seventeen");
        row1["eighteen"]=aver("tt","eighteen");
        row1["ninteen"]=aver("tt","ninteen");
        row1["twenty"]=aver("tt","twenty");
        row1["twentyone"]=aver("tt","twentyone");
        row1["twentytwo"]=aver("tt","twentytwo");
        row1["twentythree"]=aver("tt","twentythree");
        $("#tt").datagrid('appendRow',row1);
        xls1.push(row1);
       /* $("#tt").datagrid("appendRow",averageNum);*/
        /* xls.push(row);
        xls.push(averageNum);*/
    }
/*    function compute(tableName,colName) {
		var rows = $('#'+tableName).datagrid('getRows');
		var total = 0;
		for (var i = 0; i < rows.length; i++) {
			if(!rows[i][colName]){
				rows[i][colName]=0;
			}
			total += parseFloat(rows[i][colName]);
		}
		return total;
	}
	function average(tableName,colName) {
		var rows = $('#'+tableName).datagrid('getRows');
		var averageNums = 0;
		for (var i = 0; i < rows.length; i++) {
			if(!rows[i][colName]){
				rows[i][colName]=0;
			}
			averageNums += parseFloat(rows[i][colName]);
		}
		averageNums = Math.ceil(averageNums/(rows.length-noneNumber));
		noneNumber = 0;
		return averageNums;
	}*/

    var xls=[{
        _id: '日期',
        regCount: '登录人数',
        zero: '1时',
        one:'2时',
        two:'3时',
        three:'4时',
        four:'5时',
        five:'6时',
        six:'7时',
        seven:'8时',
        eight:'9时',
        nine:'10时',
        ten:'11时',
        eleven:'12时',
        twelve:'13时',
        thirteen:'14时',
        fourteen:'15时',
        fifteen:'16时',
        sixteen:'17时',
        seventeen:'18时',
        eighteen:'19时',
        ninteen:'20时',
        twenty:'21时',
        twentyone:'22时',
        twentytwo:'23时',
        twentythree:'24时'
    }];
    var xls1=[];
    //数据格式
    function downLoadXls(){
        if(!xls1)
        {
            $.messager.alert("操作提示", "无数据可导出1","error");
            return;
        }
        postJson("/tools/downloadExcelFile",{data:xls1},
                function(data)
                {
                    console.log(data);
                    if(data)
                    {
                        console.log(parent.document.location.origin);
                        document.location.href = parent.document.location.origin  + data;
                    }else
                    {
                        $.messager.alert("操作提示", "无数据可导出2","error");
                    }
                });

    }
    $(function () {
        var db = $('#db');
        db.datebox({
            onShowPanel: function () {//显示日趋选择对象后再触发弹出月份层的事件，初始化时没有生成月份层
                span.trigger('click'); //触发click事件弹出月份层
                if (!tds) setTimeout(function () {//延时触发获取月份对象，因为上面的事件触发和对象生成有时间间隔
                    tds = p.find('div.calendar-menu-month-inner td');
                    tds.click(function (e) {
                        e.stopPropagation(); //禁止冒泡执行easyui给月份绑定的事件
                        var year = /\d{4}/.exec(span.html())[0]//得到年份
                                , month = parseInt($(this).attr('abbr'), 10); //月份，这里不需要+1
                        db.datebox('hidePanel')//隐藏日期对象
                                .datebox('setValue', year + "-" + month); //设置日期的值
                    });
                }, 0);
                yearIpt.unbind();//解绑年份输入框中任何事件
            },
            parser: function (s) {
                if (!s) return new Date();
                var arr = s.split('-');
                return new Date(parseInt(arr[0], 10), parseInt(arr[1], 10) - 1, 1);
            },
            formatter: function (d) {
                return d.getFullYear()+ '-'+(d.getMonth()+1);
            }
        });
        var p = db.datebox('panel'), //日期选择对象
                tds = false, //日期选择对象中月份
                aToday = p.find('a.datebox-current'),
                yearIpt = p.find('input.calendar-menu-year'),//年份输入框
        //显示月份层的触发控件
                span = aToday.length ? p.find('div.calendar-title span') ://1.3.x版本
                        p.find('span.calendar-text'); //1.4.x版本
        if (aToday.length) {//1.3.x版本，取消Today按钮的click事件，重新绑定新事件设置日期框为今天，防止弹出日期选择面板

            aToday.unbind('click').click(function () {
                var now = new Date();
                db.datebox('hidePanel').datebox('setValue', now.getFullYear() + (now.getMonth() + 1));
            });
        }
    });
</script>
</body>
</html>
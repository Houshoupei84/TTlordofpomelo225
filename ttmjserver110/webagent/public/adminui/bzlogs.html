<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv=Content-Type content="text/html; charset=UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="email=no">
    <link rel="stylesheet" type="text/css" href="/easyui/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="/easyui/themes/icon.css">
    <link rel="stylesheet" href="../css/hygl.css"/>

    <script type="text/javascript" src="/easyui/jquery.min.js"></script>
    <script type="text/javascript" src="/easyui/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="/easyui/locale/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="/share.js"></script>
    <script type="text/javascript" src="/easyui/common.js"></script>
    <title>补钻日志</title>
</head>
<body style="width:100%;height:100%;">
<div>
    补钻日期:<input class="easyui-datebox" id="filstarttime"/>
          至 <input class="easyui-datebox" id="filendtime"/>
    <a href="javascript:void(0);" class="easyui-linkbutton" id="quire" onclick="quire()">点击查询</a>
</div>
<table id="dg" class="easyui-datagrid"  style="width:100%;height:600px;margin:0;padding:0">
</table>
<script>
    $('#dg').datagrid({
        title:'补钻日志',
        border:false,
        fitColumns:true,
        collapsible:true,
        singleSelect: true,
        remoteSort:false,
        autoRowHeight:true,
        columns:[[
            {field:'time',title:'日期',width:80,align:'center'},
            {field:'mid',title:'操作员ID',width:80,align:'center'},
            {field:'title',title:'操作类型',width:80,align:'center'},
            {field:'operateContent',title:'操作内容',width:240,align:'center'},
            {field:'commit',title:'备注',width:150,align:'center'},
            {field:'detail',title:'详情',width:80,align:'center',
                formatter:function(value,rec,index){
                    var btn = '<a class="editcls" onclick="downLoadXls('+index+')" href="javascript:void(0)">点击下载excel</a>';
                    return btn;
                }
            }
        ]]
    });
    function format(){
        var dat=new Date();
        var y = dat.getFullYear();
        var m = dat.getMonth()+1;
        if(m<10){
            m='0'+m;
        }
        var d = dat.getDate();
        if(d<10){
            d='0'+d;
        }
        return  y+'-'+m+'-'+d;
    }
    function ddhandle(timestr){
        var dayarr = timestr.split('-');
        var dayVal = dayarr[0] + dayarr[1] +dayarr[2];
        return dayVal;
    }
    function  DateDiff(sDate1,sDate2){ //sDate1和sDate2是2006-12-18格式
        var  aDate,  oDate1,  oDate2,  iDays;
        aDate  =  sDate1.split("-");
        oDate1  =  new  Date(aDate[1]  +  '-'  +  aDate[2]  +  '-'  +  aDate[0]);//转换为12-18-2006格式
        aDate  =  sDate2.split("-");
        oDate2  =  new  Date(aDate[1]  +  '-'  +  aDate[2]  +  '-'  +  aDate[0]);
        iDays  =  parseInt((oDate2  -  oDate1 ) /  1000  /  60  /  60  /24);    //把相差的毫秒数转换为天数
        return  iDays
    }
    function getStrDate(daydval){
        var loginbegin=new Date(new Date().getTime()-daydval*23*59*59*1000);
        var year = loginbegin.getFullYear();//2015
        var mon = loginbegin.getMonth()+1;//9
        if(mon<10){
            mon="0"+mon;
        }
        var day = loginbegin.getDate();//21
        if(day<10){
            day="0"+day;
        }
        return year+mon+day;
    }
    function setStrDate(daydval){
        var loginbegin=new Date(new Date().getTime()-daydval*23*59*59*1000);
        var year = loginbegin.getFullYear();//2015
        var mon = loginbegin.getMonth()+1;//9
        if(mon<10){
            mon="0"+mon;
        }
        var day = loginbegin.getDate();//21
        if(day<10){
            day="0"+day;
        }
        return year+'-'+mon+'-'+day;
    }
    //页面初始化请求近3天的补钻日志
    function quire(){
        var msg={};
        msg.startDay=ddhandle($("#filstarttime").datebox("getValue"));
        msg.endDay=ddhandle($("#filendtime").datebox("getValue"));
        var d_day=DateDiff($("#filstarttime").datebox("getValue"),$("#filendtime").datebox("getValue"));
        var d_day1=DateDiff(format(),$("#filendtime").datebox("getValue"));
        if(d_day<0){
            $.messager.alert("操作提示","初始日期小于结束日期","error");
            return;
        }
        if(d_day>=3){
            $.messager.alert("操作提示","查询天数最多可跨3天","error");
            return;
        }
        if(d_day1>0){
            $.messager.alert("操作提示","查询日期超过今日","error");
            return;
        }
        MaskUtil.mask("获取数据较慢请耐心等候");
        postJson("/admin/getSupplyDiamond",msg,function(rtn){
            MaskUtil.unmask();
            if(rtn==2){
                $.messager.alert("操作提示","未查询到结果","error");
                return;
            }
            var rows=rtn.rows;
            if(rows){
                var data={};
                data.rows=[];
                data.total=rows.length;
                for(var i=0;i<rows.length;i++){
                    /*var timeArr=rows[i]["time"].split(/[T\.]/);
                    rows[i]["time"]=timeArr[0]+" "+timeArr[1];*/
                    rows[i]["time"] = new Date(rows[i]["time"]).Format('yyyy-MM-dd hh:mm:ss');
                    downLoadData[i] = [];
                    rows[i]["operateContent"]=rows[i]["title"]+":补钻人数:"+rows[i]["members"].length+"每人补钻:"+rows[i]["num"]+"补钻总额:"+rows[i]["total"];
                    data.rows.push(rows[i]);
                    downLoadData[i].push({content: rows[i]["operateContent"]});
                    if (rows[i]["type"] == 3) {
                        downLoadData[i].push({content1: rows[i]["field"]});
                    }
                    downLoadData[i].push({members: rows[i]["members"]});
                }
                $('#dg').datagrid("loadData",data);
            }
        });
    }
    //页面请求补钻日志
    var downLoadData=[];
    function initial(){
        // 初始化默认加载3天的数据
     /*  $("#filstarttime").datebox('setValue','3/6/2017');
        $("#filendtime").datebox('setValue','3/7/2017');*/
        MaskUtil.mask("获取数据较慢请耐心等候");
        var msg={};
        msg.startDay=getStrDate(2);
        msg.endDay=ddhandle(format());
        postJson("/admin/getSupplyDiamond",msg,function(rtn){
            MaskUtil.unmask();
            if(rtn==2){
                $.messager.alert("操作提示","未查询到结果","error");
                return;
            }
            var rows=rtn.rows;
            if(rows) {
                var data = {};
                data.rows = [];
                data.total = rows.length;
                for (var i = 0; i < rows.length; i++) {
                    rows[i]["time"] = new Date(rows[i]["time"]).Format('yyyy-MM-dd hh:mm:ss');
                    downLoadData[i] = [];
                    rows[i]["operateContent"] = rows[i]["title"] + ":补钻人数:" + rows[i]["members"].length + "每人补钻:" + rows[i]["num"] + "补钻总额:" + rows[i]["total"];
                    data.rows.push(rows[i]);
                    downLoadData[i].push({content: rows[i]["operateContent"]});
                    if (rows[i]["type"] == 3) {
                        downLoadData[i].push({content1: rows[i]["field"]});
                    }
                    downLoadData[i].push({members: rows[i]["members"]});
                }
                $('#dg').datagrid("loadData", data);
            }
        });
    }
    initial();
    //打开对应的查看详情可以查看补钻详情
    var init_data=[];
    function downLoadXls(index){
       var init_data=downLoadData[index];
       var xls=[];
        var len=init_data.length;
        var column=[];
        xls.push({id:init_data[0]["content"],diaNum:""});
        if(len==3){
            var msg1={};
            msg1.id="";
            var html="筛选条件:";
            msg1.id+=html;
            msg1.diaNum="";
            if(init_data[1]["content1"]["loginday"]){
                msg1.id+="登录活跃:"+init_data[1]["content1"]["loginday"];
            }
            if(init_data[1]["content1"]["chargeday"]){
                msg1.id+="充值活跃:"+init_data[1]["content1"]["chargeday"];
            }
            if(init_data[1]["content1"]["sellday"]){
                msg1.id+="销售活跃:"+init_data[1]["content1"]["sellday"];
            }
            xls.push(msg1);
        }
        xls.push({id:"会员id",diaNum:"补钻数量"});
        for(var t=0;t<init_data[len-1]["members"].length;t++){
            var msg={};
           for(var key in init_data[len-1]["members"][t]){
               msg.id=key;
               msg.diaNum=init_data[len-1]["members"][t][key];
           }
            column.push(msg);
        }
        for(var z=0;z<column.length;z++){
            xls.push(column[z]);
        }
        if(xls.length>10002)
        {
            $.messager.alert("操作提示", "数据量过大,禁止下载","error");
            return;
        }
        if(!xls)
        {
            $.messager.alert("操作提示", "无数据可导出1","error");
            return;
        }
        postJson("/tools/downloadExcelFile",{data:xls},
                function(data)
                {
                    if(data)
                    {
                        document.location.href = parent.document.location.origin  + data;
                    }else
                    {
                        $.messager.alert("操作提示", "无数据可导出2","error");
                    }
                });
    }
</script>
</body>
</html>
<html>

<head>
    <meta http-equiv=Content-Type content="text/html; charset=UTF-8">
    <link rel="stylesheet" type="text/css" href="/easyui/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="/easyui/themes/icon.css">
    <script type="text/javascript" src="/easyui/jquery.min.js"></script>
    <script type="text/javascript" src="/easyui/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="/share.js"></script>
    <title>玩家微信支付配置</title>
</head>

<body  class="easyui-layout">
<div id="ddAlipay" class="easyui-dialog"  closed="true" title="充值修改" style="width:400px;height:400px;"
     data-options="iconCls:'icon-save',resizable:true,modal:true">

    <table width="100%">
        <tr><td><label>Id:</label></td> <td><label id="id">0</label></td></tr>
        <tr><td><label>名称:</label></td> <td><input class="easyui-validatebox" type="text" id="buyName" data-options="required:true" /></td></tr>
        <tr><td><label>金额:</label></td> <td><input class="easyui-validatebox" type="text" id="buyMoney" data-options="required:true" /></td></tr>
        <tr><td><label>数量:</label></td> <td><input class="easyui-validatebox" type="text" id="buyNum" data-options="required:true" /></td></tr>
        <tr><td><label>赠送:</label></td> <td><input class="easyui-validatebox" type="text" id="giveNum" data-options="required:true" /></td></tr>
        <tr><td><label>赠送百分比:</label></td> <td><input class="easyui-validatebox" type="text" id="givePercent" data-options="required:true" /></td></tr>
    </table>
    <a href="#" class="easyui-linkbutton" onclick="editAlipayYes()">确定</a>
</div>
<div>
    <a href="#" class="easyui-linkbutton" onclick="showCfg()">刷新</a>
    <a href="#" class="easyui-linkbutton" onclick="addAlipay()">添加充值</a>
    <a href="#" class="easyui-linkbutton" onclick="editAlipay()">修改充值</a>
    <a href="#" class="easyui-linkbutton" onclick="deleteAlipay()">删除充值</a>
</div>

<table  id="dg" class="easyui-datagrid" title="玩家微信充值配置表" style="width:100%;height:80%"
        data-options="singleSelect:true,collapsible:true,
				method:'get',
				remoteSort:false,
				multiSort:true,
				rownumbers:true,
				singleSelect:true,
				autoRowHeight:false
            ">
    <thead>
    <tr>
        <th data-options="field:'id',width:80,sortable:true">Id</th>
        <th data-options="field:'buyName',width:80,sortable:true">名称</th>
        <th data-options="field:'buyMoney',sortable:true">金额</th>
        <th data-options="field:'buyNum',sortable:true">数量</th>
        <th data-options="field:'giveNum',sortable:true">赠送</th>
        <th data-options="field:'givePercent',sortable:true">赠送百分比</th>
    </tr>
    </thead>
</table>

<script type="text/javascript">
    var data_ = {};
    var addId = 1000;

    function saveAlipayData(msg){
        postJson("/wxData/saveWxUserPayJson",{msg:{type:"content", content:msg}},
                function(data)
                {
                    if(data > 0){
                        $.messager.alert("操作提示","修改成功");
                        showCfgCommon();
                    }
                }
        );
    }

    function deleteAlipay(){
        var alipay = $("#dg").datagrid("getSelected");
        if(alipay){
            var id = alipay.id;

            if(window.confirm("删除，请确认?")) {
                postJson("/wxData/delWxUserPayJson", {msg:id.toString()}, function(data) {

                    data_ = data;

                    showCfgCommon();
                });
            }
        }
        else {
            $.message.alert("操作提示","请选择删除条目","error");
        }
    }

    function editAlipayYes(){
        //id:parseInt($('#id').val())
        var idlabel = document.getElementById("id").innerHTML;
        var msg={
            id:parseInt(idlabel),
            buyName:$('#buyName').val(),
            buyMoney:parseFloat($('#buyMoney').val()),
            buyNum:parseFloat($('#buyNum').val()),
            giveNum:parseInt($('#giveNum').val())
        };
        if(msg.buyMoney === void 0 || msg.buyMoney == null || isNaN(msg.buyMoney) || msg.buyMoney <= 0) {
            $.messager.alert("操作提示", "无效金额","error");
            return;
        }else if(msg.buyNum === void 0 || msg.buyNum == null || isNaN(msg.buyNum) || msg.buyNum < 0) {
            $.messager.alert("操作提示", "无效购买数量","error");
            return;
        }
        else if(msg.giveNum === void 0 || msg.giveNum == null || isNaN(msg.giveNum) || msg.giveNum < 0) {
            $.messager.alert("操作提示", "无效赠送数量","error");
            return;
        }

        var itemInfo = {};
        var obj = {"buyName":msg.buyName,"buyMoney":msg.buyMoney,"buyNum":msg.buyNum,"giveNum":msg.giveNum};
        data_[msg.id] = obj;
        itemInfo["id"] = msg.id;
        itemInfo["content"] = obj;

        saveAlipayData(itemInfo);

        $('#ddAlipay').dialog('close');
    }

    function editAlipay(){
        var itemSelected = $("#dg").datagrid("getSelected");
        console.log(parseInt(itemSelected.id));
        if(isNaN(parseInt(itemSelected.id))){
            $.messager.alert("操作提示", "没有可修改的项目","error");
            return;
        }
        if(itemSelected){
//				document.getElementById("id").style.display = "none";

            $("#id").html(itemSelected.id);

            $('#buyName').val(itemSelected.buyName);
            $('#buyMoney').val(itemSelected.buyMoney);
            $('#buyNum').val(itemSelected.buyNum);
            $('#giveNum').val(itemSelected.giveNum);
            $('#givePercent').val(itemSelected.givePercent);
            $('#ddAlipay').dialog('open');
        }
        else {
            $.messager.alert("操作提示", "请选择条目","error");
        }
    }

    function getAddId(){
        return (addId + 1).toString();
    }

    function addAlipay(){
        $("#id").html(getAddId());

        $('#buyName').val("");
        $('#buyMoney').val("");
        $('#buyNum').val("");
        $('#giveNum').val("");
        $('#ddAlipay').dialog('open');
    }

    function showCfgCommon(){
        addId = 0;

        var result = [];

        for(var key in data_){
            var cell = {};

            cell["id"] = key;

            if(parseInt(key) > addId){
                addId = parseInt(key);
            }

            for(var ke in data_[key]){

                cell[ke] = data_[key][ke];

            }
            cell["givePercent"]=Math.floor(data_[key]["giveNum"]/data_[key]["buyNum"]*100)+"%";
            result.push(cell);
        }

        var da = {};
        da["total"] = result.length;
        da["rows"] = result;


        $("#dg").datagrid("loadData", da);
        if(da.total==0||da==""||!da){

            $('#dg').datagrid('appendRow',{id:"没有数据", buyName:"",buyNum:"", buyMoney:"", giveNum:"",givePercent:""});

        }
    }
    function showCfg(){
        postJson("/wxData/getWxUserPayJson",{msg:"content"},
                function(data) {
                    if(!data){
                        $('#dg').datagrid('appendRow',{id:"没有数据", buyName:"",buyNum:"", buyMoney:"", giveNum:"",givePercent:""});
                        return;
                    }
                    data_ = data.content;
                    showCfgCommon();
                }
        );
    }

    $(document).ready(function () {
        showCfg();
        $("#giveNum").keyup(function(){
            $("#givePercent").val(Math.ceil(100*parseInt($("#giveNum").val())/parseInt($("#buyNum").val()))+"%");
        })
    });

</script>
</body>
</html>
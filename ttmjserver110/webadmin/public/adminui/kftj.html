<html>
<head>
    <meta http-equiv=Content-Type content="text/html; charset=UTF-8">
    <link rel="stylesheet" type="text/css" href="/easyui/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="/easyui/themes/icon.css">
    <script type="text/javascript" src="/easyui/jquery.min.js"></script>
    <script type="text/javascript" src="/easyui/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="/share.js"></script>
</head>
<body  class="easyui-layout">
<div>
    <input class="easyui-datebox" id="db"/>
    <a href="#" class="easyui-linkbutton" onclick="searchForTJData()">按月查询</a>
    <a href="#" class="easyui-linkbutton" onclick="downLoadXls()">下载excel</a>
</div>
<table  id="tt" class="easyui-datagrid" title="Basic DataGrid" style="width:100%;height:95%"
        data-options="singleSelect:true,collapsible:true">
    <thead>
    <tr>
        <th data-options="field:'_id',width:80">日期</th>
        <th data-options="field:'sumRegCount',width:80">注册总人数</th>
        <th data-options="field:'regCount',width:80">当日新增</th>
        <!--<th data-options="field:'customCount',width:80">客服人数</th>-->
        <th data-options="field:'loginCount',width:80">登录人数</th>
        <th data-options="field:'buyUserCount',width:80">充值人数</th>
        <th data-options="field:'buyNum',width:80">充值数量-钻</th>
        <th data-options="field:'sellUserCount',width:80">销售人数</th>
        <th data-options="field:'sellCount',width:80">销售次数</th>
        <th data-options="field:'sellNum',width:80">销售数量-钻</th>
        <th data-options="field:'userMoney',width:80">客服余钻-钻</th>
        <th data-options="field:'fillMembersMoney',width:80">客服补钻</th>
    </tr>
    </thead>
</table>
<script type="text/javascript">
    var xls=[{
        _id:"日期",
        sumRegCount:"注册总人数",
        regCount:"当日新增",
//        customCount:"客服人数",
        buyUserCount:"充值人数",
        loginCount:"登录人数",
        buyNum:"充值数量-钻",
        sellUserCount:"销售人数",
        sellCount:"销售次数",
        sellNum:"销售额度",
        userMoney:"客服余额",
        fillMembersMoney:"客服补钻"}];
    var xls1=[];
    function compute(tableName,colName){
        var rows = $('#'+tableName).datagrid('getRows');
        var total = 0;
        for (var i = 1; i < rows.length; i++) {
            if(!rows[i][colName]){
                rows[i][colName]=0;
            }
            total += parseFloat(rows[i][colName]);
        }
        return total;
    }
    function searchForTJData() {
        var startDate=$("#db").datebox('getValue');
        if(!startDate){
            $.messager.alert("操作提示","请选择月份","error");
            return;
        }
        var dateArr=startDate.split('-');
        if(dateArr[1]<10){
            dateArr[1]='0'+dateArr[1];
        }
        startDate=dateArr[0]+dateArr[1];
        postJson("/customerData/getCustomerStatistics",{month: startDate}, function (data) {
            var row={};
            xls1=[];
            if (data) {
                xls1 = xls.concat(data.rows.reverse());
                $("#tt").datagrid("loadData", data);
                row["_id"]='合计';
                row["sumRegCount"]='-';
                row["buyUserCount"]='-';
                row["loginCount"]='-';
                row["buyNum"]=compute("tt","buyNum");
                row["sellUserCount"]='-';
                row["sellCount"]=compute("tt","sellCount");
                row["sellNum"]=compute("tt","sellNum");
                row["userMoney"]='-';
                row["fillMembersMoney"]=compute("tt","fillMembersMoney");
                $("#tt").datagrid('appendRow',row);
                xls1.push(row);
            } else {
                $.messager.alert("操作提示", "数据请求失败", "error");
            }
        });
    }
    //数据格式
    function downLoadXls(){
        if(!xls1)
        {
            $.messager.alert("操作提示", "无数据可导出1","error");
            return;
        }
        postJson("/tools/downloadExcelFile",{data:xls1},
                function(data)
                {
                    console.log(data);
                    if(data)
                    {
                        console.log(parent.document.location.origin);
                        document.location.href = parent.document.location.origin  + data;
                    }else
                    {
                        $.messager.alert("操作提示", "无数据可导出2","error");
                    }
                });

    }
    $(function () {
        var db = $('#db');
        db.datebox({
            onShowPanel: function () {//显示日趋选择对象后再触发弹出月份层的事件，初始化时没有生成月份层
                span.trigger('click'); //触发click事件弹出月份层
                if (!tds) setTimeout(function () {//延时触发获取月份对象，因为上面的事件触发和对象生成有时间间隔
                    tds = p.find('div.calendar-menu-month-inner td');
                    tds.click(function (e) {
                        e.stopPropagation(); //禁止冒泡执行easyui给月份绑定的事件
                        var year = /\d{4}/.exec(span.html())[0]//得到年份
                                , month = parseInt($(this).attr('abbr'), 10); //月份，这里不需要+1
                        db.datebox('hidePanel')//隐藏日期对象
                                .datebox('setValue', year + "-" + month); //设置日期的值
                    });
                }, 0);
                yearIpt.unbind();//解绑年份输入框中任何事件
            },
            parser: function (s) {
                if (!s) return new Date();
                var arr = s.split('-');
                return new Date(parseInt(arr[0], 10), parseInt(arr[1], 10) - 1, 1);
            },
            formatter: function (d) {
                return d.getFullYear()+ '-'+(d.getMonth()+1);
            }
        });
        var p = db.datebox('panel'), //日期选择对象
                tds = false, //日期选择对象中月份
                aToday = p.find('a.datebox-current'),
                yearIpt = p.find('input.calendar-menu-year'),//年份输入框
        //显示月份层的触发控件
                span = aToday.length ? p.find('div.calendar-title span') ://1.3.x版本
                        p.find('span.calendar-text'); //1.4.x版本
        if (aToday.length) {//1.3.x版本，取消Today按钮的click事件，重新绑定新事件设置日期框为今天，防止弹出日期选择面板

            aToday.unbind('click').click(function () {
                var now = new Date();
                db.datebox('hidePanel').datebox('setValue', now.getFullYear() + (now.getMonth() + 1));
            });
        }
    });
</script>
</body>
</html>